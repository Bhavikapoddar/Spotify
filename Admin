
using System;
using System.Collections.Generic;
using System.Linq;
using System.Web.Mvc;
using Airline_Managementnew.Models;

namespace Airline_Managementnew.Controllers
{
    public class AdminController : Controller
    {
        private readonly DatabaseContext db = new DatabaseContext();

        // AdminPanel Action Method
        public ActionResult AdminPanel()
        {
            var allRoutes = db.SearchRequest.ToList();
            var flightCounts = db.Flight
                .GroupBy(f => f.RouteId)
                .Select(g => new
                {
                    RouteId = g.Key,
                    FlightCount = g.Count()
                })
                .ToList();
            
            var flightStatistics = allRoutes.GroupJoin(
                flightCounts,
                route => route.RouteId,
                count => count.RouteId,
                (route, group) => new FlightStatisticViewModel
                {
                    RouteName = route.FromLocation + " to " + route.Tolocation,
                    FlightCount = group.Any() ? group.Sum(c => c.FlightCount) : 0
                })
                .ToList();
            
            ViewBag.FlightStatistics = flightStatistics;
            ViewBag.Flights = db.Flight.ToList();
            ViewBag.Routes = allRoutes;
            
            return View();
        }

        // AddRoute Action Methods
        public ActionResult AddRoute()
        {
            ViewBag.Routes = db.SearchRequest.ToList();
            return View();
        }
        
        [HttpPost]
        public ActionResult AddRoute(SearchRequest route)
        {
            if (ModelState.IsValid)
            {
                db.SearchRequest.Add(route);
                db.SaveChanges();
            }
            return RedirectToAction("AddRoute");
        }

        // EditRoute Action Methods
        public ActionResult EditRoute(int id)
        {
            var route = db.SearchRequest.Find(id);
            if (route == null)
            {
                return HttpNotFound();
            }
            return View(route);
        }
        
        [HttpPost]
        public ActionResult EditRoute(SearchRequest updatedRoute)
        {
            if (ModelState.IsValid)
            {
                var route = db.SearchRequest.Find(updatedRoute.RouteId);
                if (route != null)
                {
                    route.FromLocation = updatedRoute.FromLocation;
                    route.Tolocation = updatedRoute.Tolocation;
                    route.DepartureDate = updatedRoute.DepartureDate;
                    route.RouteNumber = updatedRoute.RouteNumber;
                    db.SaveChanges();
                }
            }
            return RedirectToAction("EditRoute", new { id = updatedRoute.RouteId });
        }

        // DeleteRoute Action Method
        [HttpPost]
        public ActionResult DeleteRoute(int id)
        {
            var route = db.SearchRequest.Find(id);
            if (route != null)
            {
                db.SearchRequest.Remove(route);
                db.SaveChanges();
            }
            return RedirectToAction("AddRoute");
        }

        // AddFlight Action Methods - Standard form post
        public ActionResult AddFlight()
        {
            ViewBag.Flights = db.Flight.ToList();
            ViewBag.Routes = db.SearchRequest.ToList();
            return View();
        }

        [HttpPost]
        public ActionResult AddFlight(Flight model)
        {
            if (ModelState.IsValid)
            {
                db.Flight.Add(model);
                db.SaveChanges();
                // Redirect to AdminPanel after a successful add
                return RedirectToAction("AdminPanel");
            }
            // If model is invalid, return to the form with errors
            ViewBag.Flights = db.Flight.ToList();
            ViewBag.Routes = db.SearchRequest.ToList();
            return View(model);
        }

        // EditFlight Action Methods
        public ActionResult EditFlight(int id)
        {
            var flight = db.Flight.Find(id);
            if (flight == null)
            {
                return HttpNotFound();
            }
            ViewBag.Routes = db.SearchRequest.ToList();
            return View(flight);
        }
        
        [HttpPost]
        public ActionResult EditFlight(Flight updatedFlight)
        {
            if (ModelState.IsValid)
            {
                var flight = db.Flight.Find(updatedFlight.FlightId);
                if (flight != null)
                {
                    flight.RouteId = updatedFlight.RouteId;
                    flight.DepartureCity = updatedFlight.DepartureCity;
                    flight.ArrivalCity = updatedFlight.ArrivalCity;
                    flight.DepartureTime = updatedFlight.DepartureTime;
                    flight.ArrivalTime = updatedFlight.ArrivalTime;
                    flight.EconomyPrice = updatedFlight.EconomyPrice;
                    flight.EconomySeats = updatedFlight.EconomySeats;
                    flight.BusinessPrice = updatedFlight.BusinessPrice;
                    flight.BusinessSeats = updatedFlight.BusinessSeats;
                    flight.FirstClassPrice = updatedFlight.FirstClassPrice;
                    flight.FirstClassSeats = updatedFlight.FirstClassSeats;
                    flight.AirplaneId = updatedFlight.AirplaneId;
                    flight.AirplaneNumber = updatedFlight.AirplaneNumber;
                    db.SaveChanges();
                }
            }
            return RedirectToAction("EditFlight", new { id = updatedFlight.FlightId });
        }

        // DeleteFlight Action Method
        [HttpPost]
        public ActionResult DeleteFlight(int id)
        {
            var flight = db.Flight.Find(id);
            if (flight != null)
            {
                db.Flight.Remove(flight);
                db.SaveChanges();
            }
            return RedirectToAction("AddFlight");
        }
        
        public ActionResult PassengerInfo()
        {
            var passengers = db.Passengers.ToList();
            return View(passengers);
        }
    }
}
